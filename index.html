<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>RoTB</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            background: #333;
        }
    </style>
</head>
<body>
<div style="width: 60%; margin: 0px auto;">

<script type="text/javascript">

var game = new Phaser.Game(640, 960, Phaser.AUTO, 'ROTB', { preload: preload, create: create, update: update });

//------------------!!!!!!-----------------J ÄR X POS ----------- I ÄR Y POS----------!!!! -------------------//

var BARREL_REVEAL_ABOVE = 'Barrel Reveal Above';
var BARREL_REVEAL_BELOW = 'Barrel Reveal Below';
var BARREL_CHARGE = 'Barrel Charge';
var BARREL_MOVE_COL_UP = 'Barrel Move Row Below';
var BARREL_MOVE_ROW_LEFT = 'Barrel Move Row To The left';

var BOARD_COLS;
var BOARD_ROWS;
var counter = 0;

var TEST_CONSTANT = 6;
var BARREL_WIDTH = 80;
var BARREL_HEIGHT = 100;

var ADD_BARREL_UP = 1;
var ADD_BARREL_DOWN = 2;
var MOVE_ROW_BELLOW = 3;
var MOVE_ROW_LEFT = 4;
var CHARGE = 5;

var gameBoard;

var selectedbarrel;
var selectedBarrelStartPos;
var selectedBarrelTween;
var tempShiftedBarrel;
var tempShiftedBarrelTween;
var allowInput;


function preload() {
	console.log('preload');
    game.load.image('background', 'assets/bg.png');
    game.load.image('spriteMoveRowLeft', 'assets/barrel_move_row_left_76_96.png');
    game.load.image('spriteMoveColUp', 'assets/barrel_move_col_up_76_96.png');
    game.load.image('spriteRevealAbove', 'assets/barrel_reveal_up_green_76_96.png');
    game.load.image('spriteCharge', 'assets/barrel_charge_yellow_76_96.png');
}


function Barrel(barreltype, posx, posy, id, sprite, charge, visible) {
	this.barrelType = barreltype;
	this.posX = posx;
	this.posY = posy;
	this.barrelId = id;
	this.barrelSprite = sprite;
	this.charges = charge;
    this.visible = visible;
}

Barrel.prototype.barrelInfo = function() {
	console.log("I am the one and only barrel number:  " + this.barrelId + "  My posy is:  " + this.posX + "-" + this.posY + "  I am a mother fucking: " + this.barrelType);
}

function create() {

	console.log('create');

    text = game.add.text(250, 16, '', { fill: '#ffffff' });
    gameBoard = new Array(6);
    for(var i = 0; i < TEST_CONSTANT; i++)
    	gameBoard[i] = new Array(6);

   	spawnBoard();
}

function update() {
	//console.log('update');
}

function spawnBoard() {
	
	console.log('spawnboard()');

	for (var i = 0; i < TEST_CONSTANT; i++) {
		for(var j = 0; j < TEST_CONSTANT; j++) {
			var barrel;
			var rand = Math.round(Math.random()*3);
			if(rand === 0) {
				barrel = game.add.sprite(i*BARREL_WIDTH, j*BARREL_HEIGHT, 'spriteMoveRowLeft');
				gameBoard[i][j] = new Barrel(BARREL_MOVE_ROW_LEFT, j, i, counter, barrel, 2, false);
                barrel.alpha = false;
			} else if (rand === 1) {
				barrel = game.add.sprite(i*BARREL_WIDTH, j*BARREL_HEIGHT, 'spriteRevealAbove');
				gameBoard[i][j] = new Barrel(BARREL_REVEAL_ABOVE, j, i, counter, barrel, 2, true);
			} else if (rand == 2) {
				barrel = game.add.sprite(i*BARREL_WIDTH, j*BARREL_HEIGHT, 'spriteCharge');
				gameBoard[i][j] = new Barrel(BARREL_CHARGE, j, i, counter, barrel, 2, false);
                barrel.alpha = false;
			} else {
				barrel = game.add.sprite(i*BARREL_WIDTH, j*BARREL_HEIGHT, 'spriteMoveColUp');
				gameBoard[i][j] = new Barrel(BARREL_MOVE_COL_UP, j, i, counter, barrel, 2, false);
                barrel.alpha = false;
			}
		
			barrel.inputEnabled = true;

            if(barrel.alpha == true) {
			    gameBoard[i][j].barrelSprite.events.onInputDown.add(listener,gameBoard[i][j]);
            }
            counter++;
		}
	}
}

function listener() {	
	var expr = this.barrelType;
	switch(expr) {
		
		case BARREL_REVEAL_ABOVE:
            if(this.posX == 0 || this.charges <= 0 || gameBoard[this.posY][this.posX-1].barrelSprite.alpha == true)
                break;
			showBarrelAbove(this);
            this.charges--;
			break;

		case BARREL_REVEAL_BELOW:
			showBarrelBellow();
			break;

		case BARREL_MOVE_COL_UP:
			if(this.posY == 0 || this.charges <= 0)
				break;
			moveColUp(this);
			this.charges--;
			break;

		case BARREL_MOVE_ROW_LEFT:
			if(this.posX == TEST_CONSTANT-1 || this.charges <= 0)
				break;
			moveRowLeft(this);
			this.charges--;
			break;

		case BARREL_CHARGE:
			addCharge(this);
			break;
	}
}

function showBarrelAbove(tmpBarrel) {
    console.log('shwo above!');
    var row = tmpBarrel.posX;
    var col = tmpBarrel.posY;
    gameBoard[col][row-1].barrelSprite.alpha = true;
    gameBoard[col][row-1].barrelSprite.inputEnabled = true;
    gameBoard[col][row-1].barrelSprite.events.onInputDown.add(listener, gameBoard[col][row-1]);
}

function showBarrelBellow () {
	console.log('show bellow!');
}

function moveColUp (tmpBarrel) {
	var col = tmpBarrel.posY-1;
	var row = tmpBarrel.posX;
	var text = gameBoard[col][0].barrelSprite.key;
	var barrel = gameBoard[col][0];
	
	gameBoard[col][0].barrelSprite.loadTexture(gameBoard[col][1].barrelSprite.key);
	gameBoard[col][1].barrelSprite.loadTexture(gameBoard[col][2].barrelSprite.key);
	gameBoard[col][2].barrelSprite.loadTexture(gameBoard[col][3].barrelSprite.key);
	gameBoard[col][3].barrelSprite.loadTexture(gameBoard[col][4].barrelSprite.key);
	gameBoard[col][4].barrelSprite.loadTexture(gameBoard[col][5].barrelSprite.key);
	gameBoard[col][5].barrelSprite.loadTexture(text);

	var fooType = gameBoard[col][0].barrelType;
    var fooId = gameBoard[col][0].barrelId;
    var fooSprite = gameBoard[col][0].barrelSprite; 
    var fooCharges = gameBoard[col][0].charges;
    var fooVisible = gameBoard[col][0].visible;

    for(var i = 0; i < TEST_CONSTANT; i++) {
		if(i == TEST_CONSTANT-1) {
			gameBoard[col][5].barrelType = fooType;
			gameBoard[col][5].barrelId = fooId;
			gameBoard[col][5].charges = fooCharges;
            gameBoard[col][5].visible = fooVisible;
		} else {
			gameBoard[col][i].barrelType = gameBoard[col][i+1].barrelType;
			gameBoard[col][i].barrelId = gameBoard[col][i+1].barrelId;
			gameBoard[col][i].charges = gameBoard[col][i+1].charges;
            gameBoard[col][i].visible = gameBoard[col][i+1].visible;
		}
	}
    uppdateBarrelVisibility(col, true/*this is col*/);
}

function moveRowLeft (tmpBarrel) {
	var col = tmpBarrel.posY;
	var row = tmpBarrel.posX+1;
	var text = gameBoard[0][row].barrelSprite.key;
	var barrel = gameBoard[0][row];

	gameBoard[0][row].barrelSprite.loadTexture(gameBoard[1][row].barrelSprite.key);
	gameBoard[1][row].barrelSprite.loadTexture(gameBoard[2][row].barrelSprite.key);
	gameBoard[2][row].barrelSprite.loadTexture(gameBoard[3][row].barrelSprite.key);
	gameBoard[3][row].barrelSprite.loadTexture(gameBoard[4][row].barrelSprite.key);
	gameBoard[4][row].barrelSprite.loadTexture(gameBoard[5][row].barrelSprite.key);
	gameBoard[5][row].barrelSprite.loadTexture(text);
    
    var fooType = gameBoard[0][row].barrelType;
    var fooId = gameBoard[0][row].barrelId;
    var fooSprite = gameBoard[0][row].barrelSprite;
    var fooCharges = gameBoard[0][row].charges;
    var fooVisible = gameBoard[0][row].visible;

	for(var i = 0; i < TEST_CONSTANT; i++) {
		if(i == TEST_CONSTANT-1) {
			gameBoard[5][row].barrelType = fooType;
			gameBoard[5][row].barrelId = fooId;
			gameBoard[5][row].charges = fooCharges;
            gameBoard[5][row].visible = fooVisible;
		} else {
			gameBoard[i][row].barrelType = gameBoard[i+1][row].barrelType;
			gameBoard[i][row].barrelId = gameBoard[i+1][row].barrelId;
			gameBoard[i][row].charges = gameBoard[i+1][row].charges;
            gameBoard[i][row].visible = gameBoard[i+1][row].visible;
		}
	}
    uppdateBarrelVisibility(row, false/*this is row*/);
}

function addCharge (tmpBarrel) {
	console.log('add charge!');
	col = tmpBarrel.posY;
	row = tmpBarrel.posX;

	if(row > 0) {
		gameBoard[col][row-1].charges++;
		console.log('barrel over: ' + col + ',' + (row-1));
	}
	if(row < 5) {
		gameBoard[col][row+1].charges++;
		console.log('barrel under: ' + col + ',' + (row+1));
	}
	if(col > 0) {
		gameBoard[col-1][row].charges++;
		console.log('barrel venster: ' + (col-1) + ',' + row);
	}
	if(col < 5) {
		gameBoard[col+1][row].charges++;
		console.log('barrel hoeger: ' + (col+1) + ',' + row);
	}

}

function uppdateBarrelVisibility(tmpPos, isCol) {
	if(isCol) {
        for(var i = 0; i < TEST_CONSTANT; i++) {
            gameBoard[tmpPos][i].barrelSprite.alpha = gameBoard[tmpPos][i].visible;
            gameBoard[tmpPos][i].barrelSprite.inputEnabled = gameBoard[tmpPos][i].visible;
        }
    } else {
        for(var i = 0; i < TEST_CONSTANT; i++) {
            gameBoard[i][tmpPos].barrelSprite.alpha = gameBoard[i][tmpPos].visible;
            gameBoard[i][tmpPos].barrelSprite.alpha = gameBoard[i][tmpPos].visible;
        }
    }
}

function printRow(rowId) {
	for (var i = 0; i < TEST_CONSTANT; i++) {
   		gameBoard[i][rowId].barrelInfo();
   	}
}

function printCol(colId) {

   	for (var i = 0; i < TEST_CONSTANT; i++) {
   		gameBoard[colId][i].barrelInfo();
   	}
}

function printBoard() {
	for (var j = 0; j < TEST_CONSTANT; j++) {
   	for (var k = 0; k < TEST_CONSTANT; k++) {
   			gameBoard[j][k].barrelInfo();

   		}
   	}
}
</script>
</div>
</body>
</html>